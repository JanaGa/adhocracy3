#!/bin/bash

projects="adhocracy_frontend mercator meinberlin spd pcompass s1"

for project in $projects; do
    builddir=src/$project/$project/build

    mkdir -p $builddir
    find $builddir -type l -exec rm {} +

    # merge static directories
    for dir in `printf "src/$project/$project/static\nsrc/adhocracy_frontend/adhocracy_frontend/static" | uniq`; do
        cp -ans `readlink -f $dir`/. $builddir
    done

    # create compass config
    cat <<EOF > etc/compass_${project}.rb
http_path = "/"
css_dir = "$builddir/stylesheets"
sass_dir = "$builddir/stylesheets/scss"
fonts_dir = "$builddir/fonts"
http_fonts_path = "../fonts"
images_dir = "$builddir/images"
javascripts_dir = "$builddir/js"
sourcemap = true
add_import_path "$builddir/stylesheets/scss"
EOF

    # create hologram config
    cat <<EOF > etc/hologram_${project}.yml
source: `realpath $builddir`/stylesheets/scss
destination: `realpath $builddir`/styleguide
documentation_assets: ../docs/styleguide_assets
index: type
EOF

    # run hologram
    bin/compass compile -c etc/compass_${project}.rb
    bin/hologram etc/hologram_${project}.yml
done

for project in $projects; do
    dir=src/$project/$project/build/styleguides

    mkdir -p $dir

    for project2 in $projects; do
        ln -s `realpath src/$project2/$project2/build` $dir/$project2
        echo "<a href=\"$project2/styleguide\">$project2</a>" >> $dir/index.html
    done
done